services:
  steam-gamescope:
    build: ./src
    restart: no
    ports:
      - "27015-27050:27015-27050/tcp"
      - "27000-27250:27000-27250/udp"
      - "4380:4380/udp"

    # GPU access via NVIDIA runtime
    runtime: nvidia

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - XDG_RUNTIME_DIR=/tmp/runtime
      - PULSE_SERVER=unix:/tmp/pulse/native
      - GAMESCOPE_BACKEND
      - DEFAULT_SESSION
      - HEADLESS_DEBUG

    volumes:
      - ./steam-data:/home/steam/.local/share/Steam:rw
      - /dev/dri:/dev/dri:rw
      - /run/user/1000/pulse:/tmp/pulse:rw
      - /var/run/dbus:/var/run/dbus:rw
      - /run/user/1000/wayland-0:/tmp/runtime/host-wayland-0:rw

    devices:
      - /dev/dri:/dev/dri

    shm_size: '2gb'

    cap_add:
      - SYS_ADMIN
      # Only needed when running with debug=uinput_extra for uevent broadcasts
      #- NET_ADMIN

    security_opt:
      - seccomp:./seccomp.json
      - label:disable
