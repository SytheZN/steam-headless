services:
  steam-gamescope:
    build: ./steam-headless
    restart: no
    ipc: host
    ports:
      - "27036-27037:27036-27037/tcp"  # Steam Remote Play
      - "27031-27036:27031-27036/udp"  # Steam Remote Play

    # GPU access via NVIDIA runtime
    runtime: nvidia

    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - XDG_RUNTIME_DIR=/tmp/runtime
      - PULSE_SERVER=unix:/tmp/pulse/native
      - GAMESCOPE_BACKEND
      - DEFAULT_SESSION

    volumes:
      - ./steam-data:/home/steam/.local/share/Steam:rw
      - /dev/dri:/dev/dri:rw
      - /dev/input:/dev/input:rw
      - /run/user/1000/pulse:/tmp/pulse:rw
      - /var/run/dbus:/var/run/dbus:ro
      - /run/user/1000/wayland-0:/tmp/runtime/host-wayland-0:rw
      - /run/systemd:/run/systemd:ro

    devices:
      - /dev/uinput:/dev/uinput
      - /dev/dri:/dev/dri

    cap_add:
      - SYS_ADMIN
      - SYS_NICE

    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
